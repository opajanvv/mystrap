#!/usr/bin/env bash
#
# vault-done - Complete and delete a task
#
# Usage: vault-done "task-name"
#
# Searches tasks/inbox/ and tasks/active/ for matching files.
# - If multiple matches: outputs JSON list, exits 1
# - If single match: deletes the file, outputs JSON

set -euo pipefail

VAULT_DIR="${OBSIDIAN_VAULT:-$HOME/Cloud/janvv/life/planning}"
TASKS_DIR="$VAULT_DIR/tasks"

if [[ $# -lt 1 ]]; then
    echo "Usage: vault-done <task-name>" >&2
    exit 2
fi

query="$1"
# Remove .md extension if provided
query="${query%.md}"

# Find matching files in inbox and active
matches=()
for dir in "$TASKS_DIR/inbox" "$TASKS_DIR/active"; do
    if [[ -d "$dir" ]]; then
        while IFS= read -r -d '' file; do
            matches+=("$file")
        done < <(find "$dir" -maxdepth 1 -type f -name "*.md" ! -name "CLAUDE.md" -print0 2>/dev/null | \
            while IFS= read -r -d '' f; do
                basename="${f##*/}"
                basename="${basename%.md}"
                if [[ "${basename,,}" == *"${query,,}"* ]]; then
                    printf '%s\0' "$f"
                fi
            done)
    fi
done

# Handle results
if [[ ${#matches[@]} -eq 0 ]]; then
    echo '{"error": "No matching tasks found"}' >&2
    exit 1
fi

if [[ ${#matches[@]} -gt 1 ]]; then
    # Multiple matches - output JSON array for LLM to disambiguate
    echo -n '{"matches": ['
    first=true
    for match in "${matches[@]}"; do
        if [[ "$first" == true ]]; then
            first=false
        else
            echo -n ', '
        fi
        relpath="${match#$VAULT_DIR/}"
        name="${match##*/}"
        name="${name%.md}"
        echo -n "{\"path\": \"$relpath\", \"name\": \"$name\"}"
    done
    echo ']}'
    exit 1
fi

# Single match - delete the task
task_path="${matches[0]}"
relpath="${task_path#$VAULT_DIR/}"
filename="${task_path##*/}"
name="${filename%.md}"

# Delete the file
rm "$task_path"

# Output success JSON
echo "{\"deleted\": \"$relpath\", \"name\": \"$name\"}"
