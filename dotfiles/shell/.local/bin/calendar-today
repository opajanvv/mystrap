#!/home/jan/.local/share/uv/tools/gcalcli/bin/python
"""Fetch today's calendar events from Google Calendar."""

import datetime
import os
import sys
from pathlib import Path

from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

CONFIG_DIR = Path.home() / ".config" / "calendar-cli"
CREDENTIALS_FILE = CONFIG_DIR / "credentials.json"
TOKEN_FILE = CONFIG_DIR / "token.json"
SCOPES = ["https://www.googleapis.com/auth/calendar.readonly"]


def get_credentials():
    creds = None
    if TOKEN_FILE.exists():
        creds = Credentials.from_authorized_user_file(str(TOKEN_FILE), SCOPES)

    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file(str(CREDENTIALS_FILE), SCOPES)
            creds = flow.run_local_server(port=0)
        TOKEN_FILE.write_text(creds.to_json())

    return creds


def get_todays_events():
    creds = get_credentials()
    service = build("calendar", "v3", credentials=creds)

    # Use local timezone for correct day boundaries
    local_tz = datetime.datetime.now().astimezone().tzinfo
    today = datetime.date.today()
    start_dt = datetime.datetime.combine(today, datetime.time.min, tzinfo=local_tz)
    end_dt = datetime.datetime.combine(today, datetime.time.max, tzinfo=local_tz)

    events_result = service.events().list(
        calendarId="primary",
        timeMin=start_dt.isoformat(),
        timeMax=end_dt.isoformat(),
        singleEvents=True,
        orderBy="startTime",
    ).execute()

    events = events_result.get("items", [])

    if not events:
        print("No events today.")
        return

    today_str = today.isoformat()
    now = datetime.datetime.now(tz=local_tz)

    for event in events:
        event_start = event["start"].get("dateTime", event["start"].get("date"))
        event_end = event["end"].get("dateTime", event["end"].get("date"))

        if "T" in event_start:
            # Timed event - only show if not ended yet
            end_dt = datetime.datetime.fromisoformat(event_end)
            if end_dt <= now:
                continue
            time_str = event_start.split("T")[1][:5]
            print(f"- {time_str} {event['summary']}")
        else:
            # All-day event - always show (if it's today)
            if event_start == today_str:
                print(f"- all-day {event['summary']}")


if __name__ == "__main__":
    get_todays_events()
