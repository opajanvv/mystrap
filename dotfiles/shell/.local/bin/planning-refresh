#!/bin/bash
# planning-refresh: Process inbox, clean up, and generate TODAY.md
# Runs hourly via cron. Can also be run manually for an immediate refresh.

export PATH="$HOME/.local/bin:$PATH"
set -e

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
VAULT_DIR="$HOME/Cloud/janvv/life"
TODAY_FILE="$VAULT_DIR/planning/TODAY.md"
DATE=$(date +%Y-%m-%d)

cd "$VAULT_DIR"

# Step 1: Process Braintoss inbox
echo "Processing Braintoss inbox..."
braintoss-inbox || echo "braintoss-inbox failed or not available"

# Step 2: Archive done/killed items, purge old archives
echo "Archiving completed items..."
cleanup_result=$(python3 "$SCRIPT_DIR/planning-cleanup" 2>/dev/null || echo '{"counts":{"archived":0,"purged":0}}')
archived=$(echo "$cleanup_result" | jq -r '.counts.archived // 0')
purged=$(echo "$cleanup_result" | jq -r '.counts.purged // 0')
echo "Archived $archived items, purged $purged items"

# Step 3: Generate TODAY.md
echo "Gathering vault data..."
vault_json=$(planning-scan)
calendar=$(calendar-today 2>/dev/null || echo "")
tasks=$(tasks-today 2>/dev/null || echo "")

echo "Generating TODAY.md..."
today_md=$(echo "$vault_json" | jq -r --arg date "$DATE" --arg calendar "$calendar" --arg tasks "$tasks" '
# Capture target name for later use
(.projects.target.name // "") as $target_name |

# Start building markdown
"# Today\n\n_" + $date + "_\n\n## Hard landscape\n\n" +

# Hard landscape section
(
  (
    # Calendar events - strip leading "- " if present, then re-add uniformly
    (if $calendar != "" then ($calendar | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end) +
    # Google Tasks - same treatment
    (if $tasks != "" and ($tasks | test("No tasks") | not) then ($tasks | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end) +
    (.active_tasks.overdue // [] | map("OVERDUE: [[" + .name + "]]")) +
    (.active_tasks.due_today // [] | map("[[" + .name + "]]"))
  ) |
  if length == 0 then "_No time-bound commitments today._"
  else map("- " + .) | join("\n")
  end
) + "\n\n" +

# Focus section
(
  if .projects.target then
    "## Focus: [[" + .projects.target.name + "]]\n\n" +
    (
      if (.projects.target.unchecked_items | length) > 0 then
        (.projects.target.unchecked_items | map("- [ ] " + .) | join("\n"))
      else
        "_All steps complete. Consider adding next steps or marking project as done._"
      end
    )
  else
    "## Focus\n\n_No focus project set. Run `/process-inbox` to set one._\n\n" +
    "**Suggestions:**\n" +
    (.projects.active // [] | map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n"))
  end
) + "\n\n## Quick wins\n\n" +

# Quick wins section
(
  [.active_tasks.no_due_date // [] | .[] | select((.project == null or .project == "") and (.priority == "high" or .priority == "medium"))] |
  group_by(.priority) |
  sort_by(if .[0].priority == "high" then 0 else 1 end) |
  map(
    "**" + (.[0].priority | gsub("^(?<a>.)"; .a | ascii_upcase)) + " priority:**\n" +
    (map("- [[" + .name + "]]") | join("\n"))
  ) |
  if length == 0 then "_No standalone tasks._"
  else join("\n\n")
  end
) + "\n\n" +

# Other active projects section
(
  [.projects.active // [] | .[] | select(.name != $target_name)] |
  if length > 0 then
    "## Other active projects\n\n" +
    (map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n")) + "\n\n"
  else ""
  end
) +

# Coming up section
(
  .active_tasks.due_soon // [] |
  sort_by(.due) |
  if length > 0 then
    "## Coming up\n\n" +
    (map("- [[" + .name + "]] (due: " + .due + ")") | join("\n")) + "\n\n"
  else ""
  end
) +

# Consider section
(
  if .ideas.random_someday then
    "## Consider\n\n[[" + .ideas.random_someday.name + "]]" +
    (if .ideas.random_someday.category then " (" + .ideas.random_someday.category + ")" else "" end) + "\n"
  else ""
  end
)
')

echo "$today_md" > "$TODAY_FILE"
echo "Generated $TODAY_FILE"

echo "Done."
