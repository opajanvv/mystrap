#!/bin/bash
# planning-refresh: Process inbox, clean up, and generate TODAY.md
# Runs hourly via cron. Can also be run manually for an immediate refresh.

export PATH="$HOME/.local/bin:$PATH"
set -e

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
VAULT_DIR="$HOME/Cloud/janvv/life"
TODAY_FILE="$VAULT_DIR/planning/TODAY.md"
DATE=$(date +%Y-%m-%d)
WEEKDAY=$(date +%A)

cd "$VAULT_DIR"

# Step 1: Process Braintoss inbox
echo "Processing Braintoss inbox..."
braintoss-inbox || echo "braintoss-inbox failed or not available"

# Step 2: Archive done/killed items, purge old archives
echo "Archiving completed items..."
cleanup_result=$(python3 "$SCRIPT_DIR/planning-cleanup" 2>/dev/null || echo '{"counts":{"archived":0,"purged":0}}')
archived=$(echo "$cleanup_result" | jq -r '.counts.archived // 0')
purged=$(echo "$cleanup_result" | jq -r '.counts.purged // 0')
echo "Archived $archived items, purged $purged items"

# Step 3: Generate TODAY.md
echo "Gathering vault data..."
vault_json=$(planning-scan)
calendar=$(calendar-today 2>/dev/null || echo "")
tasks=$(tasks-today 2>/dev/null || echo "")

echo "Generating TODAY.md..."
today_md=$(echo "$vault_json" | jq -r --arg date "$DATE" --arg weekday "$WEEKDAY" --arg calendar "$calendar" --arg tasks "$tasks" '
(.projects.target.name // "") as $target_name |

# Header with weekday
"# Today - " + $weekday + " " + $date + "\n\n" +

# Hard landscape - only calendar events and Google Tasks
"## Hard landscape\n\n" +
(
  (
    (if $calendar != "" then ($calendar | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end) +
    (if $tasks != "" and ($tasks | test("No tasks") | not) then ($tasks | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end)
  ) |
  if length == 0 then "_No time-bound commitments today._"
  else map("- " + .) | join("\n")
  end
) + "\n\n" +

# Needs attention - overdue, due today, high priority standalone
"## Needs attention\n\n" +
(
  (
    (.active_tasks.overdue // [] | map("- OVERDUE: [[" + .name + "]] (was due: " + .due + ")")) +
    (.active_tasks.due_today // [] | map("- [[" + .name + "]] (due: today)")) +
    ([.active_tasks.no_due_date // [] | .[] | select((.project == null or .project == "") and .priority == "high")] | map("- [[" + .name + "]] (high)"))
  ) |
  if length == 0 then "_Nothing urgent._"
  else join("\n")
  end
) + "\n\n" +

# Focus section
(
  if .projects.target then
    "## Focus: [[" + .projects.target.name + "]]\n\n" +
    (
      if (.projects.target.unchecked_items | length) > 0 then
        (.projects.target.unchecked_items | map("- [ ] " + .) | join("\n"))
      else
        "_All steps complete. Consider adding next steps or marking project as done._"
      end
    )
  else
    "## Focus\n\n_No focus project set. Run `/process-inbox` to set one._\n\n" +
    "**Suggestions:**\n" +
    (.projects.active // [] | map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n"))
  end
) + "\n\n" +

# This week - due_soon with day names
(
  .active_tasks.due_soon // [] |
  sort_by(.due) |
  if length > 0 then
    "## This week\n\n" +
    (map("- " + (.due | strptime("%Y-%m-%d") | mktime | strftime("%a")) + ": [[" + .name + "]]") | join("\n")) + "\n\n"
  else ""
  end
) +

# Backlog - medium priority standalone tasks
(
  [.active_tasks.no_due_date // [] | .[] | select((.project == null or .project == "") and .priority == "medium")] |
  if length > 0 then
    "## Backlog\n\n" +
    (map("- [[" + .name + "]]") | join("\n")) + "\n\n"
  else ""
  end
) +

# Other active projects
(
  [.projects.active // [] | .[] | select(.name != $target_name)] |
  if length > 0 then
    "## Active projects\n\n" +
    (map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n")) + "\n\n"
  else ""
  end
) +

# Consider
(
  if .ideas.random_someday then
    "## Consider\n\n[[" + .ideas.random_someday.name + "]]" +
    (if .ideas.random_someday.category then " (" + .ideas.random_someday.category + ")" else "" end) + "\n"
  else ""
  end
)
')

echo "$today_md" > "$TODAY_FILE"
echo "Generated $TODAY_FILE"

echo "Done."
