#!/home/jan/.local/share/uv/tools/gcalcli/bin/python
"""Create a cleaning schedule Google Sheet."""

from pathlib import Path

from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

CONFIG_DIR = Path.home() / ".config" / "calendar-cli"
CREDENTIALS_FILE = CONFIG_DIR / "credentials.json"
TOKEN_FILE = CONFIG_DIR / "token-sheets.json"
SCOPES = ["https://www.googleapis.com/auth/spreadsheets"]


def get_credentials():
    creds = None
    if TOKEN_FILE.exists():
        creds = Credentials.from_authorized_user_file(str(TOKEN_FILE), SCOPES)

    if not creds or not creds.valid:
        if creds and creds.expired and creds.refresh_token:
            creds.refresh(Request())
        else:
            flow = InstalledAppFlow.from_client_secrets_file(str(CREDENTIALS_FILE), SCOPES)
            creds = flow.run_local_server(port=0)
        TOKEN_FILE.write_text(creds.to_json())

    return creds


def create_cleaning_sheet():
    creds = get_credentials()
    service = build("sheets", "v4", credentials=creds)

    # Create the spreadsheet
    spreadsheet_body = {
        "properties": {
            "title": "Cleaning Schedule"
        },
        "sheets": [
            {
                "properties": {
                    "title": "Cleaning"
                }
            }
        ]
    }

    spreadsheet = service.spreadsheets().create(body=spreadsheet_body).execute()
    sheet_id = spreadsheet["spreadsheetId"]

    # Add headers
    headers = [["Item", "Last date", "Frequency", "Next due date"]]
    body = {
        "values": headers
    }

    service.spreadsheets().values().update(
        spreadsheetId=sheet_id,
        range="Cleaning!A1",
        valueInputOption="RAW",
        body=body
    ).execute()

    # Add a sample row with formula example
    sample_row = [
        ["Keukenkast boven", "", "monthly", "=IF(B2=\"\", \"\", B2 + IF(C2=\"monthly\", 30, IF(C2=\"quarterly\", 90, IF(C2=\"yearly\", 365, 30))))"]
    ]
    body = {
        "values": sample_row
    }

    service.spreadsheets().values().update(
        spreadsheetId=sheet_id,
        range="Cleaning!A2",
        valueInputOption="USER_ENTERED",
        body=body
    ).execute()

    print(f"https://docs.google.com/spreadsheets/d/{sheet_id}")


if __name__ == "__main__":
    create_cleaning_sheet()
