#!/bin/bash
# vault-morning: Generate morning routine without LLM
# Replaces: claude -p "/morning"

set -e

VAULT_DIR="$HOME/Obsidian/life"
TODAY_FILE="$VAULT_DIR/TODAY.md"
DATE=$(date +%Y-%m-%d)

cd "$VAULT_DIR"

# Step 1: Process Braintoss inbox
echo "Processing Braintoss inbox..."
braintoss-inbox || echo "braintoss-inbox failed or not available"

# Step 2: Clean up completed items
echo "Cleaning up completed items..."
cleanup_result=$(vault-cleanup 2>/dev/null || echo '{"counts":{"total":0}}')
cleanup_count=$(echo "$cleanup_result" | jq -r '.counts.total // 0')
echo "Cleaned up $cleanup_count items"

# Step 3: Gather data
echo "Gathering vault data..."
vault_json=$(vault-scan)
calendar=$(calendar-today 2>/dev/null || echo "")
tasks=$(tasks-today 2>/dev/null || echo "")

# Step 4: Generate TODAY.md using jq
echo "Generating TODAY.md..."

# Build the markdown using jq
today_md=$(echo "$vault_json" | jq -r --arg date "$DATE" --arg calendar "$calendar" --arg tasks "$tasks" '
# Capture target name for later use
(.projects.target.name // "") as $target_name |

# Start building markdown
"# Today\n\n_" + $date + "_\n\n## Hard landscape\n\n" +

# Hard landscape section
(
  (
    # Calendar events - strip leading "- " if present, then re-add uniformly
    (if $calendar != "" then ($calendar | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end) +
    # Google Tasks - same treatment
    (if $tasks != "" and ($tasks | test("No tasks") | not) then ($tasks | split("\n") | map(select(. != "") | gsub("^- "; ""))) else [] end) +
    (.active_tasks.overdue // [] | map("OVERDUE: [[" + .name + "]]")) +
    (.active_tasks.due_today // [] | map("[[" + .name + "]]"))
  ) |
  if length == 0 then "_No time-bound commitments today._"
  else map("- " + .) | join("\n")
  end
) + "\n\n" +

# Focus section
(
  if .projects.target then
    "## Focus: [[" + .projects.target.name + "]]\n\n" +
    (
      if (.projects.target.unchecked_items | length) > 0 then
        (.projects.target.unchecked_items | map("- [ ] " + .) | join("\n"))
      else
        "_All steps complete. Consider adding next steps or marking project as done._"
      end
    )
  else
    "## Focus\n\n_No focus project set. Run `/process-inbox` to set one._\n\n" +
    "**Suggestions:**\n" +
    (.projects.active // [] | map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n"))
  end
) + "\n\n## Quick wins\n\n" +

# Quick wins section
(
  [.active_tasks.no_due_date // [] | .[] | select((.project == null or .project == "") and (.priority == "high" or .priority == "medium"))] |
  group_by(.priority) |
  sort_by(if .[0].priority == "high" then 0 else 1 end) |
  map(
    "**" + (.[0].priority | gsub("^(?<a>.)"; .a | ascii_upcase)) + " priority:**\n" +
    (map("- [[" + .name + "]]") | join("\n"))
  ) |
  if length == 0 then "_No standalone tasks._"
  else join("\n\n")
  end
) + "\n\n" +

# Other active projects section
(
  [.projects.active // [] | .[] | select(.name != $target_name)] |
  if length > 0 then
    "## Other active projects\n\n" +
    (map("- [[" + .name + "]] (" + (.unchecked_count | tostring) + " steps)") | join("\n")) + "\n\n"
  else ""
  end
) +

# Coming up section
(
  .active_tasks.due_soon // [] |
  sort_by(.due) |
  if length > 0 then
    "## Coming up\n\n" +
    (map("- [[" + .name + "]] (due: " + .due + ")") | join("\n")) + "\n\n"
  else ""
  end
) +

# Consider section
(
  if .ideas.random_someday then
    "## Consider\n\n[[" + .ideas.random_someday.name + "]]" +
    (if .ideas.random_someday.category then " (" + .ideas.random_someday.category + ")" else "" end) + "\n"
  else ""
  end
)
')

# Write TODAY.md
echo "$today_md" > "$TODAY_FILE"
echo "Generated $TODAY_FILE"

# Step 5: Commit and push
echo "Committing and pushing..."
git add -A
if git diff --staged --quiet; then
  echo "No changes to commit"
else
  git commit -m "morning: $DATE"
  git push
  echo "Pushed to remote"
fi

echo "Morning routine complete."
